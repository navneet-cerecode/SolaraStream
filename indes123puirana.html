<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ultimate Watch Party</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        background: #141414;
        color: #e5e5e5;
        margin: 0;
        padding: 20px;
        overflow-x: hidden;
        overscroll-behavior: none; 
      }

      /* --- LAYOUT --- */
      #lobby { display: block; margin-top: 15vh; }
      #videoRoom { display: none; max-width: 1400px; margin: 0 auto; padding-bottom: 50px; position: relative; }

      /* --- NOTIFICATIONS --- */
      #toastContainer {
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        display: flex; flex-direction: column; gap: 10px; pointer-events: none;
      }
      .toast {
        background: rgba(0, 123, 255, 0.9); color: white;
        padding: 10px 20px; border-radius: 4px; font-size: 0.9rem;
        animation: fadein 0.3s, fadeout 0.3s 2.7s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
      @keyframes fadein { from {opacity: 0; transform: translateX(20px);} to {opacity: 1; transform: translateX(0);} }
      @keyframes fadeout { from {opacity: 1;} to {opacity: 0;} }

      /* --- BUTTONS --- */
      input[type="text"] { padding: 15px; font-size: 1.2rem; border-radius: 4px; border: none; width: 300px; margin-bottom: 10px;}
      button { border: none; border-radius: 4px; cursor: pointer; color: white; padding: 10px 20px; font-size: 1rem; }
      .primary-btn { background: #e50914; padding: 15px 30px; font-size: 1.2rem; font-weight: bold; }
      .header-btn { background: #333; border: 1px solid #555; margin-left: 10px; }
      .fullscreen-btn { background: #007bff; border: none; }

      /* --- TOOLBAR --- */
      .video-toolbar {
        background: #222; padding: 10px 20px; margin-bottom: 15px; border-radius: 50px;
        display: inline-flex; justify-content: center; gap: 20px; align-items: center;
        border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      }
      .toolbar-hint { font-size: 0.85rem; color: #777; margin-left: 10px; font-style: italic;}

      /* --- WEBCAMS --- */
      #videoGrid { 
        display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; 
        align-items: center; position: relative; min-height: 100px;
      }
      
      /* WRAPPER FIX: Hug the content tightly */
      .video-wrapper { 
        position: relative; 
        display: inline-block; 
        width: fit-content; /* <--- CRITICAL FIX for name tag */
        height: fit-content;
        margin: 5px; 
        transition: transform 0.2s; /* Only animate transform */
      }
      
      /* DRAGGING STATE: Kill animations for instant movement */
      .video-wrapper.is-dragging {
        transition: none !important;
        z-index: 9999 !important;
        cursor: grabbing !important;
        opacity: 0.9;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      }
      
      .user-video { 
        width: 160px; height: 90px; background: #000; border-radius: 8px; 
        border: 2px solid #333; object-fit: cover; 
        cursor: grab; touch-action: none; display: block;
        transition: width 0.1s, height 0.1s; /* Smooth resize, but not drag */
      }
      
      .my-video { border-color: #28a745; }
      .video-selected .user-video { border-color: #ffd700 !important; box-shadow: 0 0 15px #ffd700; }
      .fit-stretch { object-fit: fill !important; }

      .name-tag { 
        position: absolute; bottom: 5px; left: 5px; 
        background: rgba(0,0,0,0.7); color: white; 
        padding: 2px 6px; font-size: 0.7rem; border-radius: 4px; 
        pointer-events: none; white-space: nowrap;
      }

      /* --- CHAT BOX --- */
      #chatContainer {
        position: fixed; bottom: 20px; left: 20px; width: 300px; height: 400px;
        background: rgba(0, 0, 0, 0.85); border: 1px solid #444; border-radius: 8px;
        display: none; flex-direction: column; z-index: 5000; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      }
      #chatHeader { padding: 10px; background: #222; border-bottom: 1px solid #444; font-weight: bold; cursor: move;}
      #chatMessages { flex: 1; overflow-y: auto; padding: 10px; text-align: left; }
      #chatInputArea { display: flex; border-top: 1px solid #444; }
      #chatInput { flex: 1; padding: 10px; background: transparent; border: none; color: white; outline: none; }
      #sendBtn { background: #007bff; padding: 0 15px; font-weight: bold; }
      .message { margin-bottom: 8px; font-size: 0.9rem; }
      .msg-user { font-weight: bold; color: #007bff; margin-right: 5px; }
      .msg-text { color: #ddd; }

      /* --- PLAYER --- */
      .player-container { position: relative; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 30px;}
      video#mainMovie { width: 100%; max-height: 75vh; display: block; }

      /* --- LIBRARY --- */
      .control-panel { padding: 20px; text-align: left; }
      .upload-section { background: #222; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
      .movie-card { position: relative; aspect-ratio: 2 / 3; background: #333; border-radius: 4px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
      .movie-card img { width: 100%; height: 100%; object-fit: cover; }
      .movie-card .fallback-title { display: flex; align-items: center; justify-content: center; height: 100%; padding: 10px; text-align: center; font-weight: bold; background: #222; }

      /* --- FULLSCREEN --- */
      #videoRoom:fullscreen { background-color: black; padding: 0; display: block; overflow: hidden; }
      #videoRoom:fullscreen .player-container { width: 100vw; height: 100vh; margin: 0; border-radius: 0; display: flex; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; z-index: 1; }
      #videoRoom:fullscreen video#mainMovie { width: 100%; height: 100%; max-height: none; object-fit: contain; }
      
      #videoRoom:fullscreen #videoGrid { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: transparent; display: block; pointer-events: none; z-index: 2000; margin: 0; padding: 0; }
      #videoRoom:fullscreen .video-wrapper { pointer-events: auto; position: absolute; margin: 0; }
      
      #videoRoom:fullscreen .video-toolbar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); z-index: 3000; opacity: 0; transition: opacity 0.3s; }
      #videoRoom:fullscreen .video-toolbar:hover, #videoRoom:fullscreen:hover .video-toolbar { opacity: 1; }
      #videoRoom:fullscreen .control-panel, #videoRoom:fullscreen h2, #videoRoom:fullscreen .header-btn { display: none !important; }

    </style>
  </head>
  <body>

    <div id="toastContainer"></div>

    <div id="lobby">
      <h1 style="color: #e50914;">WATCHPARTY</h1>
      <input type="text" id="usernameInput" placeholder="Your Nickname" />
      <br>
      <input type="text" id="roomInput" placeholder="Room Key (e.g. Cinema)" />
      <br><br>
      <button id="joinBtn" class="primary-btn">Enter Party</button>
    </div>

    <div id="videoRoom">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2 id="roomDisplay" style="margin:0">Room</h2>
        <div>
          <button onclick="togglePartyFullscreen()" class="header-btn fullscreen-btn">‚õ∂ Party Fullscreen</button>
          <button id="leaveBtn" class="header-btn">Exit</button>
        </div>
      </div>

      <div class="video-toolbar">
        <button class="header-btn" onclick="toggleFaces()" id="toggleFacesBtn">üëÅÔ∏è Hide Faces</button>
        <button class="header-btn" onclick="toggleChat()" id="toggleChatBtn">üí¨ Chat</button>
        <span class="toolbar-hint">üñ±Ô∏è Drag to Move ‚Ä¢ Scroll/Pinch to Resize</span>
      </div>

      <div id="videoGrid"></div>
      
      <div id="chatContainer">
        <div id="chatHeader">üí¨ Live Chat</div>
        <div id="chatMessages"></div>
        <div id="chatInputArea">
          <input type="text" id="chatInput" placeholder="Type a message...">
          <button id="sendBtn">Send</button>
        </div>
      </div>

      <div class="player-container">
        <video id="mainMovie" controls></video>
      </div>

      <div class="control-panel">
        <div class="upload-section">
          <div><label>Video:</label><input type="file" id="videoInput" accept="video/*"></div>
          <div><label>Poster:</label><input type="file" id="imageInput" accept="image/*"></div>
          <button id="uploadBtn" class="primary-btn">+ Upload</button>
        </div>
        <div id="movieGrid" class="movie-grid"><p>Loading movies...</p></div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <script>
      const socket = io();
      let myPeer = null;      
      let myStream = null;    
      let peers = {};         
      let currentRoom = null;
      let myUsername = "Anonymous";
      let isSyncing = false;

      // --- JOIN ---
      document.getElementById('joinBtn').addEventListener('click', async () => {
        const room = document.getElementById('roomInput').value.trim();
        const user = document.getElementById('usernameInput').value.trim();
        
        if(!room || !user) return alert("Enter Room AND Nickname!");
        currentRoom = room; 
        myUsername = user;

        try {
          myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          addVideoToGrid(myStream, 'me', myUsername); 
        } catch (e) { alert("Camera denied."); }

        myPeer = new Peer(undefined, { host: '/', port: 3001 });
        
        myPeer.on('open', id => {
            socket.emit('join_room', { room: currentRoom, peerId: id, username: myUsername }); 
        });

        myPeer.on('call', call => {
          call.answer(myStream);
          const callerName = (call.metadata && call.metadata.username) ? call.metadata.username : "Friend";
          call.on('stream', stream => {
             addVideoToGrid(stream, call.peer, callerName);
          });
        });

        myPeer.on('error', (err) => { console.error("PeerJS Error:", err); });

        document.getElementById('lobby').style.display = 'none';
        document.getElementById('videoRoom').style.display = 'block';
        document.getElementById('roomDisplay').innerText = `Room: ${currentRoom}`;
        refreshLibrary(); 
      });

      document.getElementById('leaveBtn').addEventListener('click', () => window.location.reload());

      // --- SMART SYNC ---
      socket.on('ask_time', (requesterId) => {
        const time = document.getElementById('mainMovie').currentTime;
        socket.emit('sync_time', { time: time, userToSync: requesterId });
      });
      socket.on('get_time', (time) => {
        const video = document.getElementById('mainMovie');
        video.currentTime = time;
      });

      // --- NOTIFICATIONS ---
      socket.on('notification', (msg) => showToast(msg));
      function showToast(text) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast'; toast.innerText = text;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // --- CHAT ---
      function toggleChat() {
        const chat = document.getElementById('chatContainer');
        chat.style.display = (chat.style.display === 'flex') ? 'none' : 'flex';
      }
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('chatInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

      function sendMessage() {
        const input = document.getElementById('chatInput');
        if(input.value.trim()) { socket.emit('send_message', input.value.trim()); input.value = ""; }
      }
      socket.on('receive_message', (data) => {
        const chat = document.getElementById('chatMessages');
        chat.innerHTML += `<div class="message"><span class="msg-user">${data.user}:</span><span class="msg-text">${data.text}</span></div>`;
        chat.scrollTop = chat.scrollHeight;
      });

      // --- WEBRTC ---
      socket.on('user_connected', (data) => setTimeout(() => connectToNewUser(data.peerId, myStream, data.username), 1000));
      socket.on('user_disconnected', (userId) => { if (peers[userId]) peers[userId].close(); removeVideo(userId); });

      function connectToNewUser(userId, stream, username) {
        const call = myPeer.call(userId, stream, { metadata: { username: myUsername } });
        call.on('stream', userVideoStream => addVideoToGrid(userVideoStream, userId, username));
        call.on('close', () => removeVideo(userId));
        peers[userId] = call;
      }

      function addVideoToGrid(stream, userId, username) {
        if (document.getElementById('vid-' + userId)) return; 
        
        const wrapper = document.createElement('div'); 
        wrapper.className = 'video-wrapper'; 
        wrapper.id = 'wrap-' + userId;

        const video = document.createElement('video'); 
        video.id = 'vid-' + userId; 
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => video.play()); 
        video.className = 'user-video';
        
        if (userId === 'me') { video.classList.add('my-video'); video.muted = true; }
        
        const tag = document.createElement('div'); 
        tag.className = 'name-tag'; 
        tag.innerText = username || "User";

        wrapper.appendChild(video); 
        wrapper.appendChild(tag);
        
        makeInteractable(wrapper, video);
        document.getElementById('videoGrid').append(wrapper);
      }
      
      function removeVideo(userId) { const el = document.getElementById('wrap-' + userId); if (el) el.remove(); }

      // ==========================================
      // === üöÄ OPTIMIZED INTERACTIVITY ENGINE ===
      // ==========================================
      function makeInteractable(wrapper, videoEl) {
        
        // 1. SELECT
        wrapper.addEventListener('mousedown', () => {
             document.querySelectorAll('.video-wrapper').forEach(w => w.classList.remove('video-selected'));
             wrapper.classList.add('video-selected');
        });

        // 2. RESIZE (Smooth)
        wrapper.addEventListener('wheel', (e) => {
            e.preventDefault();
            let currentW = videoEl.offsetWidth;
            let newW = currentW + (e.deltaY * -0.5); 
            if (newW > 50 && newW < 600) {
                // Update VIDEO size. Wrapper will fit-content automatically.
                videoEl.style.width = newW + 'px';
                videoEl.style.height = (newW * 0.56) + 'px';
            }
        });

        // 3. DRAG (Optimized)
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;
        let rafId = null; // Request Animation Frame ID

        const startDrag = (e) => {
            if (!document.fullscreenElement) return; // Only drag in Fullscreen
            
            isDragging = true;
            wrapper.classList.add('is-dragging'); // Kill animations

            // Get standard coordinate (Touch or Mouse)
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            startX = clientX;
            startY = clientY;

            // Lock position to fixed
            const rect = wrapper.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;

            wrapper.style.position = 'fixed';
            wrapper.style.left = initialLeft + 'px';
            wrapper.style.top = initialTop + 'px';
            wrapper.style.right = 'auto';
            wrapper.style.margin = 0;
        };

        const doDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();

            // Run visuals in Animation Frame for performance
            if (rafId) cancelAnimationFrame(rafId);

            rafId = requestAnimationFrame(() => {
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const dx = clientX - startX;
                const dy = clientY - startY;
                wrapper.style.left = `${initialLeft + dx}px`;
                wrapper.style.top = `${initialTop + dy}px`;
            });
        };

        const stopDrag = () => {
            if (!isDragging) return;
            isDragging = false;
            wrapper.classList.remove('is-dragging'); // Restore animations
            if (rafId) cancelAnimationFrame(rafId);
        };

        wrapper.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', doDrag);
        window.addEventListener('mouseup', stopDrag);
        wrapper.addEventListener('touchstart', startDrag);
        window.addEventListener('touchmove', doDrag);
        window.addEventListener('touchend', stopDrag);
      }

      function togglePartyFullscreen() {
        const elem = document.getElementById('videoRoom');
        if (!document.fullscreenElement) {
          elem.requestFullscreen().catch(err => alert(err.message));
          
          // Initial Fullscreen Layout (Stacked Right)
          const wraps = document.querySelectorAll('.video-wrapper'); 
          let topOffset = 20;
          wraps.forEach(w => { 
            w.style.position = 'absolute'; 
            w.style.right = '20px'; 
            w.style.top = topOffset + 'px'; 
            w.style.left = 'auto'; 
            topOffset += 110; 
          });

        } else {
          document.exitFullscreen();
          
          // Reset Layout for Grid
          const wraps = document.querySelectorAll('.video-wrapper'); 
          wraps.forEach(w => { 
            w.style.position = 'relative'; 
            w.style.right = 'auto'; 
            w.style.top = 'auto'; 
            w.style.left = 'auto'; 
            w.style.margin = '5px';
            w.classList.remove('is-dragging'); // Ensure clean state
          });
        }
      }

      function toggleFaces() {
        const grid = document.getElementById('videoGrid'); const btn = document.getElementById('toggleFacesBtn');
        if (grid.style.visibility === 'hidden') { grid.style.visibility = 'visible'; btn.innerText = "üëÅÔ∏è Hide Faces"; } 
        else { grid.style.visibility = 'hidden'; btn.innerText = "üëÅÔ∏è Show Faces"; }
      }

      // --- SYNC ---
      const mainMovie = document.getElementById('mainMovie');
      mainMovie.addEventListener('play', () => { if(!isSyncing && currentRoom) socket.emit('play_video', currentRoom); });
      mainMovie.addEventListener('pause', () => { if(!isSyncing && currentRoom) socket.emit('pause_video', currentRoom); });
      mainMovie.addEventListener('seeked', () => { if(!isSyncing && currentRoom) socket.emit('seek_video', { room: currentRoom, time: mainMovie.currentTime }); });

      socket.on('play_video', () => { isSyncing = true; mainMovie.play(); setTimeout(()=>isSyncing=false, 500); });
      socket.on('pause_video', () => { isSyncing = true; mainMovie.pause(); setTimeout(()=>isSyncing=false, 500); });
      socket.on('seek_video', (t) => { isSyncing = true; mainMovie.currentTime = t; setTimeout(()=>isSyncing=false, 1000); });
      socket.on('change_movie', (data) => {
        const path = `/uploads/${data.room}/${data.filename}`;
        if (!mainMovie.src.includes(encodeURIComponent(data.filename))) { mainMovie.src = path; mainMovie.play(); }
      });

      document.getElementById('uploadBtn').addEventListener('click', async () => {
        const vidInput = document.getElementById('videoInput'); const imgInput = document.getElementById('imageInput'); const btn = document.getElementById('uploadBtn');
        if(!vidInput.files[0]) return alert("Select video!");
        btn.innerText = "Uploading..."; btn.disabled = true;
        const formData = new FormData(); formData.append('room', currentRoom); formData.append('videoFile', vidInput.files[0]);
        if(imgInput.files[0]) formData.append('imageFile', imgInput.files[0]); 
        try { const res = await fetch('/upload', { method: 'POST', body: formData }); if(res.ok) { alert("Done!"); refreshLibrary(); } else { alert("Failed."); } } catch (err) { alert("Error."); }
        btn.innerText = "+ Upload"; btn.disabled = false; vidInput.value = ""; imgInput.value = "";
      });

      async function refreshLibrary() {
        if(!currentRoom) return;
        const grid = document.getElementById('movieGrid');
        try {
            const res = await fetch(`/files?room=${currentRoom}`); const items = await res.json(); grid.innerHTML = "";
            items.forEach(item => {
              const card = document.createElement('div'); card.className = 'movie-card'; card.onclick = () => window.playMovie(item.video);
              card.innerHTML = item.image ? `<img src="/uploads/${currentRoom}/${item.image}"><div class="play-overlay"><div class="play-icon">‚ñ∂</div></div>` : `<div class="fallback-title">${item.video}</div><div class="play-overlay"><div class="play-icon">‚ñ∂</div></div>`;
              grid.appendChild(card);
            });
        } catch(e) { console.log(e); }
      }
      window.playMovie = (f) => socket.emit('change_movie', { room: currentRoom, filename: f });
    </script>
  </body>
</html>